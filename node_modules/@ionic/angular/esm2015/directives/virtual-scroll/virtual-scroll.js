import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, Component, ContentChild, ElementRef, EmbeddedViewRef, IterableDiffer, IterableDiffers, NgZone, SimpleChanges, TrackByFunction } from '@angular/core';
import { ProxyCmp } from '../proxies-utils';
import { VirtualFooter } from './virtual-footer';
import { VirtualHeader } from './virtual-header';
import { VirtualItem } from './virtual-item';
import * as ɵngcc0 from '@angular/core';

const _c0 = ["*"];
let IonVirtualScroll = class IonVirtualScroll {
    constructor(z, iterableDiffers, elementRef) {
        this.z = z;
        this.iterableDiffers = iterableDiffers;
        this.refMap = new WeakMap();
        this.el = elementRef.nativeElement;
        this.el.nodeRender = this.nodeRender.bind(this);
    }
    ngOnChanges(changes) {
        if (this.trackBy && 'items' in changes) {
            // React on virtualScroll changes only once all inputs have been initialized
            const value = changes['items'].currentValue;
            if (this.differ === undefined && value != null) {
                try {
                    this.differ = this.iterableDiffers.find(value).create(this.trackBy);
                }
                catch (e) {
                    throw new Error(`Cannot find a differ supporting object '${value}'. VirtualScroll only supports binding to Iterables such as Arrays.`);
                }
            }
        }
    }
    ngDoCheck() {
        // and if there actually are changes
        const changes = this.differ !== undefined && this.items ? this.differ.diff(this.items) : null;
        if (changes === null) {
            return;
        }
        // TODO: optimize
        this.checkRange(0);
    }
    nodeRender(el, cell, index) {
        return this.z.run(() => {
            let node;
            if (!el) {
                node = this.itmTmp.viewContainer.createEmbeddedView(this.getComponent(cell.type), { $implicit: cell.value, index }, index);
                el = getElement(node);
                this.refMap.set(el, node);
            }
            else {
                node = this.refMap.get(el);
                const ctx = node.context;
                ctx.$implicit = cell.value;
                ctx.index = cell.index;
            }
            // run sync change detections
            node.detectChanges();
            return el;
        });
    }
    getComponent(type) {
        switch (type) {
            case 'item': return this.itmTmp.templateRef;
            case 'header': return this.hdrTmp.templateRef;
            case 'footer': return this.ftrTmp.templateRef;
        }
        throw new Error('template for virtual item was not provided');
    }
};
IonVirtualScroll.ɵfac = function IonVirtualScroll_Factory(t) { return new (t || IonVirtualScroll)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.NgZone), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.IterableDiffers), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
IonVirtualScroll.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: IonVirtualScroll, selectors: [["ion-virtual-scroll"]], contentQueries: function IonVirtualScroll_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualItem, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualHeader, true);
        ɵngcc0.ɵɵcontentQuery(dirIndex, VirtualFooter, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.itmTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.hdrTmp = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.ftrTmp = _t.first);
    } }, inputs: { approxItemHeight: "approxItemHeight", approxHeaderHeight: "approxHeaderHeight", approxFooterHeight: "approxFooterHeight", headerFn: "headerFn", footerFn: "footerFn", items: "items", itemHeight: "itemHeight", headerHeight: "headerHeight", footerHeight: "footerHeight", trackBy: "trackBy" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], ngContentSelectors: _c0, decls: 1, vars: 0, template: function IonVirtualScroll_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
    } }, encapsulation: 2, changeDetection: 0 });
IonVirtualScroll.ctorParameters = () => [
    { type: NgZone },
    { type: IterableDiffers },
    { type: ElementRef }
];
tslib_1.__decorate([
    ContentChild(VirtualItem, { static: false })
], IonVirtualScroll.prototype, "itmTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualHeader, { static: false })
], IonVirtualScroll.prototype, "hdrTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualFooter, { static: false })
], IonVirtualScroll.prototype, "ftrTmp", void 0);
IonVirtualScroll = tslib_1.__decorate([
    ProxyCmp({
        inputs: ['approxItemHeight', 'approxHeaderHeight', 'approxFooterHeight', 'headerFn', 'footerFn', 'items', 'itemHeight', 'headerHeight', 'footerHeight'],
        methods: ['checkEnd', 'checkRange', 'positionForItem']
    }),
], IonVirtualScroll);
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(IonVirtualScroll, [{
        type: Component,
        args: [{
                selector: 'ion-virtual-scroll',
                template: '<ng-content></ng-content>',
                changeDetection: ChangeDetectionStrategy.OnPush,
                inputs: [
                    'approxItemHeight',
                    'approxHeaderHeight',
                    'approxFooterHeight',
                    'headerFn',
                    'footerFn',
                    'items',
                    'itemHeight',
                    'headerHeight',
                    'footerHeight',
                    'trackBy'
                ]
            }]
    }], function () { return [{ type: ɵngcc0.NgZone }, { type: ɵngcc0.IterableDiffers }, { type: ɵngcc0.ElementRef }]; }, { itmTmp: [{
            type: ContentChild,
            args: [VirtualItem, { static: false }]
        }], hdrTmp: [{
            type: ContentChild,
            args: [VirtualHeader, { static: false }]
        }], ftrTmp: [{
            type: ContentChild,
            args: [VirtualFooter, { static: false }]
        }] }); })();
export { IonVirtualScroll };
const getElement = (view) => {
    const rootNodes = view.rootNodes;
    for (let i = 0; i < rootNodes.length; i++) {
        if (rootNodes[i].nodeType === 1) {
            return rootNodes[i];
        }
    }
    throw new Error('virtual element was not created');
};
const ɵ0 = getElement;
export { ɵ0 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zY3JvbGwuanMiLCJzb3VyY2VzIjpbIm5nOi9AaW9uaWMvYW5ndWxhci9kaXJlY3RpdmVzL3ZpcnR1YWwtc2Nyb2xsL3ZpcnR1YWwtc2Nyb2xsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHdkwsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRTVDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBZ0k3QyxJQUFhLGdCQUFnQixHQUE3QixNQUFhLGdCQUFnQjtBQUM3QixJQVNFLFlBQ1UsQ0FBUyxFQUNULGVBQWdDLEVBQ3hDLFVBQXNCO0FBQ3hCLFFBSFUsTUFBQyxHQUFELENBQUMsQ0FBUTtBQUFDLFFBQ1Ysb0JBQWUsR0FBZixlQUFlLENBQWlCO0FBQUMsUUFSbkMsV0FBTSxHQUFHLElBQUksT0FBTyxFQUFnRCxDQUFDO0FBQy9FLFFBVUksSUFBSSxDQUFDLEVBQUUsR0FBRyxVQUFVLENBQUMsYUFBNEMsQ0FBQztBQUN0RSxRQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3BELElBQUUsQ0FBQztBQUNILElBQ0UsV0FBVyxDQUFDLE9BQXNCO0FBQUksUUFDcEMsSUFBSSxJQUFJLENBQUMsT0FBTyxJQUFJLE9BQU8sSUFBSSxPQUFPLEVBQUU7QUFDNUMsWUFBTSw0RUFBNEU7QUFDbEYsWUFBTSxN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O29CQTZFRDtBQUNBLFNBN0VhLGdCQUFnQjtBQTZFN0IsTUFBTSxVQUFVLEdBQUcsQ0FBQyxJQUFxQyxFQUFlLEVBQUU7QUFDMUUsSUFBRSxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0FBQ25DLElBQUUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDN0MsUUFBSSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxFQUFFO0FBQ3JDLFlBQU0sT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDMUIsU0FBSztBQUNMLEtBQUc7QUFDSCxJQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUFDRjtBQUF1QjtBQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgQ29udGVudENoaWxkLCBFbGVtZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEl0ZXJhYmxlRGlmZmVyLCBJdGVyYWJsZURpZmZlcnMsIE5nWm9uZSwgU2ltcGxlQ2hhbmdlcywgVHJhY2tCeUZ1bmN0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDZWxsLCBDZWxsVHlwZSwgRm9vdGVySGVpZ2h0Rm4sIEhlYWRlckZuLCBIZWFkZXJIZWlnaHRGbiwgSXRlbUhlaWdodEZuIH0gZnJvbSAnQGlvbmljL2NvcmUnO1xuXG5pbXBvcnQgeyBQcm94eUNtcCB9IGZyb20gJy4uL3Byb3hpZXMtdXRpbHMnO1xuXG5pbXBvcnQgeyBWaXJ0dWFsRm9vdGVyIH0gZnJvbSAnLi92aXJ0dWFsLWZvb3Rlcic7XG5pbXBvcnQgeyBWaXJ0dWFsSGVhZGVyIH0gZnJvbSAnLi92aXJ0dWFsLWhlYWRlcic7XG5pbXBvcnQgeyBWaXJ0dWFsSXRlbSB9IGZyb20gJy4vdmlydHVhbC1pdGVtJztcbmltcG9ydCB7IFZpcnR1YWxDb250ZXh0IH0gZnJvbSAnLi92aXJ0dWFsLXV0aWxzJztcblxuZXhwb3J0IGRlY2xhcmUgaW50ZXJmYWNlIElvblZpcnR1YWxTY3JvbGwge1xuICAvKipcbiAgICogSXQgaXMgaW1wb3J0YW50IHRvIHByb3ZpZGUgdGhpc1xuICAgKiBpZiB2aXJ0dWFsIGl0ZW0gaGVpZ2h0IHdpbGwgYmUgc2lnbmlmaWNhbnRseSBsYXJnZXIgdGhhbiB0aGUgZGVmYXVsdFxuICAgKiBUaGUgYXBwcm94aW1hdGUgaGVpZ2h0IG9mIGVhY2ggdmlydHVhbCBpdGVtIHRlbXBsYXRlJ3MgY2VsbC5cbiAgICogVGhpcyBkaW1lbnNpb24gaXMgdXNlZCB0byBoZWxwIGRldGVybWluZSBob3cgbWFueSBjZWxscyBzaG91bGRcbiAgICogYmUgY3JlYXRlZCB3aGVuIGluaXRpYWxpemVkLCBhbmQgdG8gaGVscCBjYWxjdWxhdGUgdGhlIGhlaWdodCBvZlxuICAgKiB0aGUgc2Nyb2xsYWJsZSBhcmVhLiBUaGlzIGhlaWdodCB2YWx1ZSBjYW4gb25seSB1c2UgYHB4YCB1bml0cy5cbiAgICogTm90ZSB0aGF0IHRoZSBhY3R1YWwgcmVuZGVyZWQgc2l6ZSBvZiBlYWNoIGNlbGwgY29tZXMgZnJvbSB0aGVcbiAgICogYXBwJ3MgQ1NTLCB3aGVyZWFzIHRoaXMgYXBwcm94aW1hdGlvbiBpcyB1c2VkIHRvIGhlbHAgY2FsY3VsYXRlXG4gICAqIGluaXRpYWwgZGltZW5zaW9ucyBiZWZvcmUgdGhlIGl0ZW0gaGFzIGJlZW4gcmVuZGVyZWQuXG4gICAqL1xuICBhcHByb3hJdGVtSGVpZ2h0OiBudW1iZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBhcHByb3hpbWF0ZSBoZWlnaHQgb2YgZWFjaCBoZWFkZXIgdGVtcGxhdGUncyBjZWxsLlxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxuICAgKiBiZSBjcmVhdGVkIHdoZW4gaW5pdGlhbGl6ZWQsIGFuZCB0byBoZWxwIGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxuICAgKiBhcHAncyBDU1MsIHdoZXJlYXMgdGhpcyBhcHByb3hpbWF0aW9uIGlzIHVzZWQgdG8gaGVscCBjYWxjdWxhdGVcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cbiAgICovXG4gIGFwcHJveEhlYWRlckhlaWdodDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgYXBwcm94aW1hdGUgd2lkdGggb2YgZWFjaCBmb290ZXIgdGVtcGxhdGUncyBjZWxsLlxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxuICAgKiBiZSBjcmVhdGVkIHdoZW4gaW5pdGlhbGl6ZWQsIGFuZCB0byBoZWxwIGNhbGN1bGF0ZSB0aGUgaGVpZ2h0IG9mXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxuICAgKiBhcHAncyBDU1MsIHdoZXJlYXMgdGhpcyBhcHByb3hpbWF0aW9uIGlzIHVzZWQgdG8gaGVscCBjYWxjdWxhdGVcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cbiAgICovXG4gIGFwcHJveEZvb3RlckhlaWdodDogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBTZWN0aW9uIGhlYWRlcnMgYW5kIHRoZSBkYXRhIHVzZWQgd2l0aGluIGl0cyBnaXZlblxuICAgKiB0ZW1wbGF0ZSBjYW4gYmUgZHluYW1pY2FsbHkgY3JlYXRlZCBieSBwYXNzaW5nIGEgZnVuY3Rpb24gdG8gYGhlYWRlckZuYC5cbiAgICogRm9yIGV4YW1wbGUsIGEgbGFyZ2UgbGlzdCBvZiBjb250YWN0cyB1c3VhbGx5IGhhcyBkaXZpZGVycyBiZXR3ZWVuIGVhY2hcbiAgICogbGV0dGVyIGluIHRoZSBhbHBoYWJldC4gQXBwJ3MgY2FuIHByb3ZpZGUgdGhlaXIgb3duIGN1c3RvbSBgaGVhZGVyRm5gXG4gICAqIHdoaWNoIGlzIGNhbGxlZCB3aXRoIGVhY2ggcmVjb3JkIHdpdGhpbiB0aGUgZGF0YXNldC4gVGhlIGxvZ2ljIHdpdGhpblxuICAgKiB0aGUgaGVhZGVyIGZ1bmN0aW9uIGNhbiBkZWNpZGUgaWYgdGhlIGhlYWRlciB0ZW1wbGF0ZSBzaG91bGQgYmUgdXNlZCxcbiAgICogYW5kIHdoYXQgZGF0YSB0byBnaXZlIHRvIHRoZSBoZWFkZXIgdGVtcGxhdGUuIFRoZSBmdW5jdGlvbiBtdXN0IHJldHVyblxuICAgKiBgbnVsbGAgaWYgYSBoZWFkZXIgY2VsbCBzaG91bGRuJ3QgYmUgY3JlYXRlZC5cbiAgICovXG4gIGhlYWRlckZuPzogSGVhZGVyRm47XG5cbiAgLyoqXG4gICAqIFNlY3Rpb24gZm9vdGVycyBhbmQgdGhlIGRhdGEgdXNlZCB3aXRoaW4gaXRzIGdpdmVuXG4gICAqIHRlbXBsYXRlIGNhbiBiZSBkeW5hbWljYWxseSBjcmVhdGVkIGJ5IHBhc3NpbmcgYSBmdW5jdGlvbiB0byBgZm9vdGVyRm5gLlxuICAgKiBUaGUgbG9naWMgd2l0aGluIHRoZSBmb290ZXIgZnVuY3Rpb24gY2FuIGRlY2lkZSBpZiB0aGUgZm9vdGVyIHRlbXBsYXRlXG4gICAqIHNob3VsZCBiZSB1c2VkLCBhbmQgd2hhdCBkYXRhIHRvIGdpdmUgdG8gdGhlIGZvb3RlciB0ZW1wbGF0ZS4gVGhlIGZ1bmN0aW9uXG4gICAqIG11c3QgcmV0dXJuIGBudWxsYCBpZiBhIGZvb3RlciBjZWxsIHNob3VsZG4ndCBiZSBjcmVhdGVkLlxuICAgKi9cbiAgZm9vdGVyRm4/OiBIZWFkZXJGbjtcblxuICAvKipcbiAgICogVGhlIGRhdGEgdGhhdCBidWlsZHMgdGhlIHRlbXBsYXRlcyB3aXRoaW4gdGhlIHZpcnR1YWwgc2Nyb2xsLlxuICAgKiBJdCdzIGltcG9ydGFudCB0byBub3RlIHRoYXQgd2hlbiB0aGlzIGRhdGEgaGFzIGNoYW5nZWQsIHRoZW4gdGhlXG4gICAqIGVudGlyZSB2aXJ0dWFsIHNjcm9sbCBpcyByZXNldCwgd2hpY2ggaXMgYW4gZXhwZW5zaXZlIG9wZXJhdGlvbiBhbmRcbiAgICogc2hvdWxkIGJlIGF2b2lkZWQgaWYgcG9zc2libGUuXG4gICAqL1xuICBpdGVtcz86IGFueVtdO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIHdpdGhpbiB0aGVpciBoZWlnaHQuXG4gICAqIFdoZW4gdGhpcyBmdW5jdGlvbiBpcyBwcm92aWRlZCwgaGVhdnkgb3B0aW1pemF0aW9ucyBhbmQgZmFzdCBwYXRoIGNhbiBiZSB0YWtlZCBieVxuICAgKiBgaW9uLXZpcnR1YWwtc2Nyb2xsYCBsZWFkaW5nIHRvIG1hc3NpdmUgcGVyZm9ybWFuY2UgaW1wcm92ZW1lbnRzLlxuICAgKlxuICAgKiBUaGlzIGZ1bmN0aW9uIGFsbG93cyB0byBza2lwIGFsbCBET00gcmVhZHMsIHdoaWNoIGNhbiBiZSBEb2luZyBzbyBsZWFkc1xuICAgKiB0byBtYXNzaXZlIHBlcmZvcm1hbmNlXG4gICAqL1xuICBpdGVtSGVpZ2h0PzogSXRlbUhlaWdodEZuO1xuXG4gIC8qKlxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIGhlYWRlciB3aXRoaW4gdGhlaXIgaGVpZ2h0LlxuICAgKi9cbiAgaGVhZGVySGVpZ2h0PzogSGVhZGVySGVpZ2h0Rm47XG5cbiAgLyoqXG4gICAqIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRoYXQgbWFwcyBlYWNoIGl0ZW0gZm9vdGVyIHdpdGhpbiB0aGVpciBoZWlnaHQuXG4gICAqL1xuICBmb290ZXJIZWlnaHQ/OiBGb290ZXJIZWlnaHRGbjtcblxuICAvKipcbiAgICogU2FtZSBhcyBgbmdGb3JUcmFja0J5YCB3aGljaCBjYW4gYmUgdXNlZCBvbiBgbmdGb3JgLlxuICAgKi9cbiAgdHJhY2tCeTogVHJhY2tCeUZ1bmN0aW9uPGFueT47XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIG1hcmtzIHRoZSB0YWlsIHRoZSBpdGVtcyBhcnJheSBhcyBkaXJ0eSwgc28gdGhleSBjYW4gYmUgcmUtcmVuZGVyZWQuICBJdCdzIGVxdWl2YWxlbnQgdG8gY2FsbGluZzogIGBgYGpzICAgICogdmlydHVhbFNjcm9sbC5jaGVja1JhbmdlKGxhc3RJdGVtTGVuLCBpdGVtcy5sZW5ndGggLSBsYXN0SXRlbUxlbik7ICAgICogYGBgXG4gICAqL1xuICAnY2hlY2tFbmQnOiAoKSA9PiB2b2lkO1xuICAvKipcbiAgICogVGhpcyBtZXRob2QgbWFya3MgYSBzdWJzZXQgb2YgaXRlbXMgYXMgZGlydHksIHNvIHRoZXkgY2FuIGJlIHJlLXJlbmRlcmVkLiBJdGVtcyBzaG91bGQgYmUgbWFya2VkIGFzIGRpcnR5IGFueSB0aW1lIHRoZSBjb250ZW50IG9yIHRoZWlyIHN0eWxlIGNoYW5nZXMuICBUaGUgc3Vic2V0IG9mIGl0ZW1zIHRvIGJlIHVwZGF0ZWQgY2FuIGFyZSBzcGVjaWZpbmcgYnkgYW4gb2Zmc2V0IGFuZCBhIGxlbmd0aC5cbiAgICovXG4gICdjaGVja1JhbmdlJzogKG9mZnNldDogbnVtYmVyLCBsZW4/OiBudW1iZXIpID0+IHZvaWQ7XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBwb3NpdGlvbiBvZiB0aGUgdmlydHVhbCBpdGVtIGF0IHRoZSBnaXZlbiBpbmRleC5cbiAgICovXG4gICdwb3NpdGlvbkZvckl0ZW0nOiAoaW5kZXg6IG51bWJlcikgPT4gUHJvbWlzZTxudW1iZXI+O1xufVxuXG5AUHJveHlDbXAoe1xuICBpbnB1dHM6IFsnYXBwcm94SXRlbUhlaWdodCcsICdhcHByb3hIZWFkZXJIZWlnaHQnLCAnYXBwcm94Rm9vdGVySGVpZ2h0JywgJ2hlYWRlckZuJywgJ2Zvb3RlckZuJywgJ2l0ZW1zJywgJ2l0ZW1IZWlnaHQnLCAnaGVhZGVySGVpZ2h0JywgJ2Zvb3RlckhlaWdodCddLFxuICBtZXRob2RzOiBbJ2NoZWNrRW5kJywgJ2NoZWNrUmFuZ2UnLCAncG9zaXRpb25Gb3JJdGVtJ11cbn0pXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdpb24tdmlydHVhbC1zY3JvbGwnLFxuICB0ZW1wbGF0ZTogJzxuZy1jb250ZW50PjwvbmctY29udGVudD4nLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgaW5wdXRzOiBbXG4gICAgJ2FwcHJveEl0ZW1IZWlnaHQnLFxuICAgICdhcHByb3hIZWFkZXJIZWlnaHQnLFxuICAgICdhcHByb3hGb290ZXJIZWlnaHQnLFxuICAgICdoZWFkZXJGbicsXG4gICAgJ2Zvb3RlckZuJyxcbiAgICAnaXRlbXMnLFxuICAgICdpdGVtSGVpZ2h0JyxcbiAgICAnaGVhZGVySGVpZ2h0JyxcbiAgICAnZm9vdGVySGVpZ2h0JyxcbiAgICAndHJhY2tCeSdcbiAgXVxufSlcbmV4cG9ydCBjbGFzcyBJb25WaXJ0dWFsU2Nyb2xsIHtcblxuICBwcml2YXRlIGRpZmZlcj86IEl0ZXJhYmxlRGlmZmVyPGFueT47XG4gIHByaXZhdGUgZWw6IEhUTUxJb25WaXJ0dWFsU2Nyb2xsRWxlbWVudDtcbiAgcHJpdmF0ZSByZWZNYXAgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0Pj4oKTtcblxuICBAQ29udGVudENoaWxkKFZpcnR1YWxJdGVtLCB7IHN0YXRpYzogZmFsc2UgfSkgaXRtVG1wITogVmlydHVhbEl0ZW07XG4gIEBDb250ZW50Q2hpbGQoVmlydHVhbEhlYWRlciwgeyBzdGF0aWM6IGZhbHNlIH0pIGhkclRtcCE6IFZpcnR1YWxIZWFkZXI7XG4gIEBDb250ZW50Q2hpbGQoVmlydHVhbEZvb3RlciwgeyBzdGF0aWM6IGZhbHNlIH0pIGZ0clRtcCE6IFZpcnR1YWxGb290ZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB6OiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSBpdGVyYWJsZURpZmZlcnM6IEl0ZXJhYmxlRGlmZmVycyxcbiAgICBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICApIHtcbiAgICB0aGlzLmVsID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IGFzIEhUTUxJb25WaXJ0dWFsU2Nyb2xsRWxlbWVudDtcbiAgICB0aGlzLmVsLm5vZGVSZW5kZXIgPSB0aGlzLm5vZGVSZW5kZXIuYmluZCh0aGlzKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50cmFja0J5ICYmICdpdGVtcycgaW4gY2hhbmdlcykge1xuICAgICAgLy8gUmVhY3Qgb24gdmlydHVhbFNjcm9sbCBjaGFuZ2VzIG9ubHkgb25jZSBhbGwgaW5wdXRzIGhhdmUgYmVlbiBpbml0aWFsaXplZFxuICAgICAgY29uc3QgdmFsdWUgPSBjaGFuZ2VzWydpdGVtcyddLmN1cnJlbnRWYWx1ZTtcbiAgICAgIGlmICh0aGlzLmRpZmZlciA9PT0gdW5kZWZpbmVkICYmIHZhbHVlICE9IG51bGwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLmRpZmZlciA9IHRoaXMuaXRlcmFibGVEaWZmZXJzLmZpbmQodmFsdWUpLmNyZWF0ZSh0aGlzLnRyYWNrQnkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYENhbm5vdCBmaW5kIGEgZGlmZmVyIHN1cHBvcnRpbmcgb2JqZWN0ICcke3ZhbHVlfScuIFZpcnR1YWxTY3JvbGwgb25seSBzdXBwb3J0cyBiaW5kaW5nIHRvIEl0ZXJhYmxlcyBzdWNoIGFzIEFycmF5cy5gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nRG9DaGVjaygpIHtcbiAgICAvLyBhbmQgaWYgdGhlcmUgYWN0dWFsbHkgYXJlIGNoYW5nZXNcbiAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5kaWZmZXIgIT09IHVuZGVmaW5lZCAmJiB0aGlzLml0ZW1zID8gdGhpcy5kaWZmZXIuZGlmZih0aGlzLml0ZW1zKSA6IG51bGw7XG4gICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8gVE9ETzogb3B0aW1pemVcbiAgICB0aGlzLmNoZWNrUmFuZ2UoMCk7XG4gIH1cblxuICBwcml2YXRlIG5vZGVSZW5kZXIoZWw6IEhUTUxFbGVtZW50IHwgbnVsbCwgY2VsbDogQ2VsbCwgaW5kZXg6IG51bWJlcik6IEhUTUxFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy56LnJ1bigoKSA9PiB7XG4gICAgICBsZXQgbm9kZTogRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0PjtcbiAgICAgIGlmICghZWwpIHtcbiAgICAgICAgbm9kZSA9IHRoaXMuaXRtVG1wLnZpZXdDb250YWluZXIuY3JlYXRlRW1iZWRkZWRWaWV3KFxuICAgICAgICAgIHRoaXMuZ2V0Q29tcG9uZW50KGNlbGwudHlwZSksXG4gICAgICAgICAgeyAkaW1wbGljaXQ6IGNlbGwudmFsdWUsIGluZGV4IH0sXG4gICAgICAgICAgaW5kZXhcbiAgICAgICAgKTtcbiAgICAgICAgZWwgPSBnZXRFbGVtZW50KG5vZGUpO1xuICAgICAgICB0aGlzLnJlZk1hcC5zZXQoZWwsIG5vZGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbm9kZSA9IHRoaXMucmVmTWFwLmdldChlbCkhO1xuICAgICAgICBjb25zdCBjdHggPSBub2RlLmNvbnRleHQ7XG4gICAgICAgIGN0eC4kaW1wbGljaXQgPSBjZWxsLnZhbHVlO1xuICAgICAgICBjdHguaW5kZXggPSBjZWxsLmluZGV4O1xuICAgICAgfVxuICAgICAgLy8gcnVuIHN5bmMgY2hhbmdlIGRldGVjdGlvbnNcbiAgICAgIG5vZGUuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgcmV0dXJuIGVsO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDb21wb25lbnQodHlwZTogQ2VsbFR5cGUpIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2l0ZW0nOiByZXR1cm4gdGhpcy5pdG1UbXAudGVtcGxhdGVSZWY7XG4gICAgICBjYXNlICdoZWFkZXInOiByZXR1cm4gdGhpcy5oZHJUbXAudGVtcGxhdGVSZWY7XG4gICAgICBjYXNlICdmb290ZXInOiByZXR1cm4gdGhpcy5mdHJUbXAudGVtcGxhdGVSZWY7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGUgZm9yIHZpcnR1YWwgaXRlbSB3YXMgbm90IHByb3ZpZGVkJyk7XG4gIH1cbn1cblxuY29uc3QgZ2V0RWxlbWVudCA9ICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8VmlydHVhbENvbnRleHQ+KTogSFRNTEVsZW1lbnQgPT4ge1xuICBjb25zdCByb290Tm9kZXMgPSB2aWV3LnJvb3ROb2RlcztcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290Tm9kZXMubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAocm9vdE5vZGVzW2ldLm5vZGVUeXBlID09PSAxKSB7XG4gICAgICByZXR1cm4gcm9vdE5vZGVzW2ldO1xuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoJ3ZpcnR1YWwgZWxlbWVudCB3YXMgbm90IGNyZWF0ZWQnKTtcbn07XG4iXX0=